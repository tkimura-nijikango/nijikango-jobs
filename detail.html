<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Ê±Ç‰∫∫Ë©≥Á¥∞ - „Éã„Ç∏ÁúãË≠∑</title>
    <link rel="icon" type="image/png" href="./logo.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f88caa',
                        'primary-hover': '#e07b99',
                        'primary-light': '#fff0f4',
                        'primary-dark': '#d16a88',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'Hiragino Sans', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @keyframes bounce-loader { 0%,100%{transform:scale(0)} 50%{transform:scale(1)} }
        .animate-bounce-loader { animation: bounce-loader 1s infinite ease-in-out; }
    </style>
</head>

<body class="bg-gray-50 font-sans pb-24">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 flex flex-col justify-center items-center z-[9999]">
        <div class="w-16 h-16 bg-primary rounded-full animate-bounce-loader relative">
            <span class="absolute top-4 left-3 w-3 h-3 bg-white rounded-full"></span>
            <span class="absolute top-4 right-3 w-3 h-3 bg-white rounded-full"></span>
        </div>
        <div class="mt-5 text-primary font-bold text-lg">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>

    <!-- Modal -->
    <div id="customModal" class="fixed inset-0 bg-black/50 hidden justify-center items-center z-[10000]">
        <div class="bg-white p-8 rounded-2xl text-center w-[90%] max-w-[400px] shadow-2xl">
            <div id="modalText" class="text-gray-800 text-lg leading-relaxed mb-6 whitespace-pre-wrap"></div>
            <div id="modalButtons" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-[1000] bg-white shadow-sm border-b border-gray-100 flex justify-between items-center px-4 h-14">
        <a href="javascript:void(0)" onclick="closeTabOrBack()"
            class="no-underline text-gray-800 font-bold flex items-center gap-1 text-sm">
            <span>&#9664;</span> <span>Êàª„Çã</span>
        </a>
        <div class="flex items-center gap-2">
            <img src="logo.jpg" alt="„Éã„Ç∏ÁúãË≠∑" class="h-7 w-auto">
            <span class="text-base font-bold text-primary">Ê±Ç‰∫∫Ë©≥Á¥∞</span>
        </div>
        <div class="w-[50px]"></div>
    </header>

    <!-- Content -->
    <div id="content" class="p-4 max-w-[800px] mx-auto"></div>

    <!-- Action Bar -->
    <div class="fixed bottom-0 left-0 w-full bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.1)] px-4 py-3 flex justify-center gap-3 z-[1000]"
        id="actionBar" style="display:none;">
        <button id="addCartBtn"
            class="flex-1 max-w-[180px] bg-white text-primary border-2 border-primary font-bold py-3.5 rounded-lg text-base cursor-pointer flex items-center justify-center transition-all active:scale-[0.98]">
            Ôºã Ê∞ó„Å´„Å™„Çã
        </button>
        <button id="applyBtn"
            class="flex-1 max-w-[400px] bg-primary text-white font-bold border-none py-3.5 rounded-lg text-base cursor-pointer flex items-center justify-center shadow-[0_4px_6px_rgba(248,140,170,0.3)] transition-all active:scale-[0.98]">
            „Åì„ÅÆÊ±Ç‰∫∫„Å´ÂøúÂãü„Åô„Çã
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        const DATA_URL = './jobs.zip';
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwT4dlPuH3edMjF5aWRV_TgAzU0Rz7YS76Zb-H0Dv3G02ph0DR1KY006ldArCJZngFs/exec';

        const params = new URLSearchParams(window.location.search);
        const jobId = params.get('id');
        const uid = params.get('uid') || '';

        let currentJob = null;
        const cart = new Set(JSON.parse(localStorage.getItem('nijikango_cart') || '[]').map(String));

        window.addEventListener('DOMContentLoaded', async () => {
            if (!jobId) {
                showError('Ê±Ç‰∫∫ID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            try {
                let job = null;

                // Strategy 1: localStorage cache (instant)
                const cached = getCachedJobs();
                if (cached) {
                    job = cached.find(j => String(j['Ê±Ç‰∫∫Áï™Âè∑'] || j['Ê±Ç‰∫∫ID']) === String(jobId));
                    if (job) console.log('Loaded from cache');
                }

                // Strategy 2: Fetch from jobs.zip
                if (!job) {
                    const res = await fetch(`${DATA_URL}?t=${Date.now()}`);
                    if (!res.ok) throw new Error('Failed to load');
                    const blob = await res.blob();
                    const zip = await JSZip.loadAsync(blob);
                    const fn = Object.keys(zip.files).find(n => n.endsWith('.json'));
                    if (!fn) throw new Error('No JSON');
                    const txt = await zip.files[fn].async('string');
                    const data = JSON.parse(txt);
                    job = data.find(j => String(j['Ê±Ç‰∫∫Áï™Âè∑'] || j['Ê±Ç‰∫∫ID']) === String(jobId));
                    if (job) console.log('Loaded from zip');
                }

                if (job) {
                    currentJob = job;
                    renderJob(job);
                } else {
                    showError('Ë©≤ÂΩì„Åô„ÇãÊ±Ç‰∫∫„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                }
            } catch (e) {
                console.error(e);
                showError('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            } finally {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 400);
            }
        });

        function getCachedJobs() {
            try {
                const cache = localStorage.getItem('jobs_cache');
                if (!cache) return null;
                const parsed = JSON.parse(cache);
                if (Date.now() - parsed.timestamp < 3 * 60 * 60 * 1000) return parsed.data;
                return null;
            } catch (e) { return null; }
        }

        function renderJob(job) {
            const title = job['Ê±Ç‰∫∫„Çø„Ç§„Éà„É´'] || 'Ê±Ç‰∫∫Ë©≥Á¥∞';
            const facility = job['ÊñΩË®≠Âêç'] || 'ÈùûÂÖ¨Èñã';
            const jobNumber = String(job['Ê±Ç‰∫∫Áï™Âè∑'] || job['Ê±Ç‰∫∫ID'] || '');

            // Tags
            const facilityType = job['ÊñΩË®≠ÂΩ¢ÊÖã'] || '';
            const empType = job['ÈõáÁî®ÂΩ¢ÊÖã'] || '';
            const featuresRaw = job['„Çø„Ç∞ÔºàÁâπÂæ¥Ôºâ'] || job['ÁâπÂæ¥„Çø„Ç∞'] || '';
            const tags = featuresRaw.split(',').filter(Boolean);
            if (facilityType) tags.unshift(facilityType);

            const tagHtml = tags.map(t => {
                if (t === facilityType) {
                    return `<span class="text-xs px-2.5 py-1 rounded bg-primary-light text-primary font-medium">${t}</span>`;
                }
                return `<span class="text-xs px-2.5 py-1 rounded bg-gray-100 text-gray-600">${t}</span>`;
            }).join('');

            // Points
            const p1 = job['POINT1'] || '';
            const p2 = job['POINT2'] || '';
            const p3 = job['POINT3'] || '';
            const points = [p1, p2, p3].filter(Boolean);
            const pointsHtml = points.length > 0 ? `
                <div class="bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl p-4 border border-pink-100 mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-base">‚ú®</span>
                        <h2 class="text-sm font-bold text-primary">„Åä„Åô„Åô„ÇÅ„Éù„Ç§„É≥„Éà</h2>
                    </div>
                    <ul class="space-y-2">
                        ${points.map(p => `<li class="flex items-start gap-2 text-sm text-gray-700"><span class="text-primary mt-0.5">‚óè</span><span>${escapeHtml(p)}</span></li>`).join('')}
                    </ul>
                </div>` : '';

            // Interview note
            const note = job['ÂèñÊùêNOTE'] || '';
            const noteHtml = note ? `
                <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-100 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-base">üìù</span>
                        <h2 class="text-sm font-bold text-yellow-700">ÂèñÊùê„É°„É¢</h2>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${escapeHtml(note)}</p>
                </div>` : '';

            // Detail table fields
            const fields = [
                { label: 'ÊñΩË®≠ÂΩ¢ÊÖã', value: facilityType },
                { label: 'ËÅ∑Á®Æ', value: job['ËÅ∑Á®Æ'] || '' },
                { label: 'ÈõáÁî®ÂΩ¢ÊÖã', value: empType },
                { label: 'Âã§ÂãôÂΩ¢ÊÖã', value: job['Âã§ÂãôÂΩ¢ÊÖã'] || '' },
                { label: 'Âã§ÂãôÂú∞', value: buildLocation(job) },
                { label: 'ÊúÄÂØÑÈßÖ', value: job['ÊúÄÂØÑÈßÖÔºàË∑ØÁ∑öÔºâ'] || '' },
                { label: 'Âπ¥Âèé', value: job['Âπ¥Âèé'] || '', highlight: true },
                { label: 'ÊúàÁµ¶', value: job['ÊúàÁµ¶'] || '' },
                { label: 'ÊôÇÁµ¶', value: job['ÊôÇÁµ¶'] || '' },
                { label: 'Áµ¶‰∏éÂÇôËÄÉ', value: job['Áµ¶‰∏éÂÇôËÄÉ'] || '' },
                { label: 'ÂêÑÁ®ÆÊâãÂΩì', value: job['ÂêÑÁ®ÆÊâãÂΩì'] || '' },
                { label: 'Ê•≠ÂãôÂÜÖÂÆπ', value: job['Ê•≠ÂãôÂÜÖÂÆπ'] || job['ÊãÖÂΩìÊ•≠Âãô'] || '' },
                { label: 'ÁµåÈ®ì„Éª„Çπ„Ç≠„É´', value: job['ÁµåÈ®ì„Éª„Çπ„Ç≠„É´'] || '' },
                { label: 'Âã§ÂãôÊôÇÈñì', value: job['Âã§ÂãôÊôÇÈñì'] || '' },
                { label: '‰ºëÊó•', value: job['‰ºëÊó•'] || '' },
                { label: 'Á¶èÂà©ÂéöÁîü', value: job['Á¶èÂà©ÂéöÁîü'] || '' },
                { label: 'ÈÄöÂã§‰∫§ÈÄöË≤ª', value: job['ÈÄöÂã§‰∫§ÈÄöË≤ª'] || '' },
                { label: 'Ë®∫ÁôÇÁßëÁõÆ', value: job['Ë®∫ÁôÇÁßëÁõÆ'] || '' },
            ].filter(f => f.value && String(f.value).trim() && f.value !== '-');

            const tableHtml = fields.map(f => `
                <tr>
                    <th class="text-left py-3 px-2 border-b border-gray-100 align-top w-[28%] text-gray-500 font-normal text-sm">${f.label}</th>
                    <td class="text-left py-3 px-2 border-b border-gray-100 align-top leading-relaxed whitespace-pre-wrap text-sm ${f.highlight ? 'text-primary font-bold' : 'text-gray-800'}">${escapeHtml(String(f.value))}</td>
                </tr>`).join('');

            const html = `
                <div class="bg-white rounded-xl p-5 shadow-sm mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-xs">No.${jobNumber}</span>
                        ${empType ? `<span class="text-xs text-gray-500 border border-gray-200 rounded px-1.5 py-0.5">${empType}</span>` : ''}
                    </div>
                    <div class="text-sm font-bold text-gray-700 mb-1">${escapeHtml(facility)}</div>
                    <h1 class="text-xl font-bold text-primary leading-snug mb-4">${escapeHtml(title)}</h1>
                    <div class="flex flex-wrap gap-2 mb-4">${tagHtml}</div>

                    <!-- Salary highlight -->
                    ${job['Âπ¥Âèé'] ? `
                    <div class="bg-primary-light rounded-lg p-3 mb-4 flex items-center gap-2">
                        <span class="text-lg">üí∞</span>
                        <span class="text-primary font-bold text-lg">${escapeHtml(job['Âπ¥Âèé'])}</span>
                    </div>` : ''}
                </div>

                ${pointsHtml}
                ${noteHtml}

                <div class="bg-white rounded-xl p-5 shadow-sm mb-4">
                    <h2 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="w-1 h-4 bg-primary rounded-full inline-block"></span>
                        Ê±Ç‰∫∫Ë©≥Á¥∞
                    </h2>
                    <table class="w-full border-collapse text-sm">
                        ${tableHtml}
                    </table>
                </div>

                <div style="height:20px;"></div>
            `;

            document.getElementById('content').innerHTML = html;

            // Cart button
            const cartBtn = document.getElementById('addCartBtn');
            updateCartBtn(cartBtn, jobNumber);

            cartBtn.onclick = () => {
                if (cart.has(jobNumber)) {
                    cart.delete(jobNumber);
                } else {
                    cart.add(jobNumber);
                }
                localStorage.setItem('nijikango_cart', JSON.stringify(Array.from(cart)));
                updateCartBtn(cartBtn, jobNumber);
            };

            // Apply button
            const applyBtn = document.getElementById('applyBtn');
            applyBtn.onclick = async (e) => {
                e.preventDefault();
                if (applyBtn.classList.contains('disabled')) return;

                showModal('ÂøúÂãüÂá¶ÁêÜ‰∏≠„Åß„Åô...');
                await new Promise(r => setTimeout(r, 600));

                showModal('ÂøúÂãü„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\nLINE„Å´Ê≠£Âºè„Å™Ê°àÂÜÖ„Çí„ÅäÈÄÅ„Çä„Åô„Çã„ÅÆ„Åß„ÄÅ\n„Éà„Éº„ÇØÁîªÈù¢„Å´Êàª„Å£„Å¶„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ', true);

                applyBtn.textContent = 'ÂøúÂãüÊ∏à„Åø';
                applyBtn.classList.add('disabled');
                applyBtn.style.backgroundColor = '#ccc';
                applyBtn.style.pointerEvents = 'none';
                applyBtn.style.boxShadow = 'none';

                // Send apply to GAS
                if (uid) {
                    try {
                        fetch(GAS_API_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: 'apply', userId: uid, jobId: jobNumber })
                        }).catch(err => console.error('Apply error:', err));
                    } catch (err) { console.error('Apply error:', err); }
                }
            };

            document.getElementById('actionBar').style.display = 'flex';
            document.title = `${title} - „Éã„Ç∏ÁúãË≠∑`;
        }

        function buildLocation(job) {
            const parts = [
                job['ÈÉΩÈÅìÂ∫úÁúå'] || '',
                job['Â∏ÇÂå∫Áî∫Êùë'] || '',
                job['Âã§ÂãôÂú∞'] || ''
            ].filter(Boolean);
            // Deduplicate if Âã§ÂãôÂú∞ already contains prefecture/city
            if (parts.length > 1) {
                const loc = parts[parts.length - 1];
                return parts.filter((p, i) => i === parts.length - 1 || !loc.includes(p)).concat(
                    loc.includes(parts[0]) ? [] : []
                ).join(' ') || loc;
            }
            return parts.join(' ') || '';
        }

        function updateCartBtn(btn, jobNumber) {
            if (cart.has(jobNumber)) {
                btn.textContent = '‚úî ÈÅ∏ÊäûÊ∏à„Åø';
                btn.classList.remove('bg-white');
                btn.classList.add('bg-primary-light');
            } else {
                btn.textContent = 'Ôºã Ê∞ó„Å´„Å™„Çã';
                btn.classList.remove('bg-primary-light');
                btn.classList.add('bg-white');
            }
        }

        function showModal(text, hasCloseBtn = false) {
            const modal = document.getElementById('customModal');
            const msg = document.getElementById('modalText');
            const btns = document.getElementById('modalButtons');

            msg.textContent = text;
            btns.innerHTML = '';

            if (hasCloseBtn) {
                const btn = document.createElement('button');
                btn.className = 'bg-primary text-white border-none py-3 px-6 rounded-full text-base font-bold cursor-pointer transition-opacity active:opacity-80 min-w-[120px]';
                btn.textContent = 'Èñâ„Åò„Çã';
                btn.onclick = () => {
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                    closeTabOrBack();
                };
                btns.appendChild(btn);
            }

            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function showError(msg) {
            document.getElementById('content').innerHTML = `<div class="text-center py-10 text-red-500 bg-white rounded-xl mt-4">${msg}</div>`;
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function closeTabOrBack() {
            // If there's history from same domain, go back
            if (window.history.length > 1 && document.referrer && document.referrer.includes(location.hostname)) {
                window.history.back();
                return;
            }
            // Otherwise redirect to list page
            let target = 'index.html';
            if (uid) target += `?uid=${encodeURIComponent(uid)}`;
            window.location.href = target;
        }
    </script>
</body>

</html>
