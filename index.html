<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>æ±‚äººæ¤œç´¢ - ãƒ‹ã‚¸çœ‹è­·</title>
    <link rel="icon" type="image/png" href="./logo.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f88caa',
                        'primary-hover': '#e07b99',
                        'primary-light': '#fff0f4',
                        'primary-dark': '#d16a88',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'Hiragino Sans', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @keyframes bounce-loader { 0%,100%{transform:scale(0)} 50%{transform:scale(1)} }
        .animate-bounce-loader { animation: bounce-loader 1s infinite ease-in-out; }
        @keyframes fade-in-up { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease forwards; }
        @keyframes slide-up { from{transform:translateX(-50%) translateY(100px)} to{transform:translateX(-50%) translateY(0)} }
        .cart-bar-enter { animation: slide-up 0.3s cubic-bezier(0.175,0.885,0.32,1.275) forwards; }
        @keyframes heart-pop { 0%{transform:scale(1)} 50%{transform:scale(1.3)} 100%{transform:scale(1)} }
        .heart-pop { animation: heart-pop 0.3s ease; }
        .chip-active { background-color:#f88caa!important; color:white!important; border-color:#f88caa!important; }
        .hide-scrollbar::-webkit-scrollbar { display:none; }
        .hide-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    </style>
</head>

<body class="bg-gray-50 font-sans text-gray-800 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-[9999]">
        <div class="w-16 h-16 bg-primary rounded-full animate-bounce-loader relative">
            <span class="absolute top-4 left-3 w-3 h-3 bg-white rounded-full"></span>
            <span class="absolute top-4 right-3 w-3 h-3 bg-white rounded-full"></span>
        </div>
        <div class="mt-5 text-primary font-bold text-lg">æ±‚äººã‚’æ¢ã—ã¦ã„ã¾ã™...</div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <img src="logo.jpg" alt="ãƒ‹ã‚¸çœ‹è­·" class="h-8 w-auto">
                <span class="text-xl font-bold text-primary tracking-tight">ãƒ‹ã‚¸çœ‹è­· æ±‚äºº</span>
            </div>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="bg-primary">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row gap-2">
                <div class="flex-1">
                    <input type="text" id="keywordInput"
                        class="w-full h-12 px-4 rounded-lg border-2 border-transparent focus:border-pink-300 focus:outline-none text-base placeholder-gray-400"
                        placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€è·ç¨®åãªã©">
                </div>
                <div class="flex-1 md:max-w-xs">
                    <select id="regionInput"
                        class="w-full h-12 px-4 rounded-lg border-2 border-transparent focus:border-pink-300 focus:outline-none text-base bg-white text-gray-700 appearance-none"
                        style="background-image:url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath fill=%27%23666%27 d=%27M6 8L1 3h10z%27/%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 12px center;padding-right:36px;">
                        <option value="">ã™ã¹ã¦ã®ã‚¨ãƒªã‚¢</option>
                        <option value="é–¢æ±">é–¢æ±</option>
                        <option value="é–¢è¥¿">é–¢è¥¿</option>
                        <option value="æ±æµ·">æ±æµ·</option>
                        <option value="ä¹å·">ä¹å·ãƒ»æ²–ç¸„</option>
                        <option value="åŒ—æµ·é“ãƒ»æ±åŒ—">åŒ—æµ·é“ãƒ»æ±åŒ—</option>
                        <option value="ç”²ä¿¡è¶Šãƒ»åŒ—é™¸">ç”²ä¿¡è¶Šãƒ»åŒ—é™¸</option>
                        <option value="ä¸­å›½ãƒ»å››å›½">ä¸­å›½ãƒ»å››å›½</option>
                    </select>
                </div>
                <button id="searchBtn"
                    class="h-12 px-8 bg-white hover:bg-gray-50 text-primary font-bold rounded-lg transition-colors text-base flex-shrink-0">
                    æ¤œç´¢
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex flex-wrap items-center gap-2">
                <select id="salaryInput"
                    class="text-sm border border-gray-200 rounded-full px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-primary/30 appearance-none pr-8"
                    style="background-image:url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath fill=%27%23999%27 d=%27M5 7L1 3h8z%27/%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 8px center;">
                    <option value="0">å¹´åã“ã ã‚ã‚‰ãªã„</option>
                    <option value="300">300ä¸‡å††ä»¥ä¸Š</option>
                    <option value="400">400ä¸‡å††ä»¥ä¸Š</option>
                    <option value="500">500ä¸‡å††ä»¥ä¸Š</option>
                    <option value="600">600ä¸‡å††ä»¥ä¸Š</option>
                </select>
                <select id="categoryInput"
                    class="text-sm border border-gray-200 rounded-full px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-primary/30 appearance-none pr-8"
                    style="background-image:url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath fill=%27%23999%27 d=%27M5 7L1 3h8z%27/%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 8px center;">
                    <option value="">ã™ã¹ã¦ã®æ–½è¨­</option>
                    <option value="ç—…é™¢">ç—…é™¢</option>
                    <option value="ã‚¯ãƒªãƒ‹ãƒƒã‚¯">ã‚¯ãƒªãƒ‹ãƒƒã‚¯</option>
                    <option value="è¨ªå•çœ‹è­·">è¨ªå•çœ‹è­·</option>
                    <option value="ä»‹è­·æ–½è¨­">ä»‹è­·æ–½è¨­</option>
                    <option value="ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯">ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯</option>
                    <option value="å¥è¨ºã‚»ãƒ³ã‚¿ãƒ¼">å¥è¨ºã‚»ãƒ³ã‚¿ãƒ¼</option>
                    <option value="ä¿è‚²åœ’ãƒ»å­¦æ ¡">ä¿è‚²åœ’ãƒ»å­¦æ ¡</option>
                </select>
                <button id="filterToggleBtn" class="text-sm text-primary font-medium flex items-center gap-1 hover:underline">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
                    <span id="filterToggleText">è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</span>
                </button>
            </div>
            <div id="detailFilters" class="hidden mt-3 pt-3 border-t border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-xs text-gray-500 font-medium mb-1 block">éƒ½é“åºœçœŒ</label>
                        <select id="prefSelect" class="w-full text-sm border border-gray-200 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-primary/30" disabled>
                            <option value="">å…ˆã«ã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-medium mb-1 block">é›‡ç”¨å½¢æ…‹</label>
                        <select id="employmentInput" class="w-full text-sm border border-gray-200 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-primary/30">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="å¸¸å‹¤">å¸¸å‹¤</option>
                            <option value="éå¸¸å‹¤">éå¸¸å‹¤ãƒ»ãƒ‘ãƒ¼ãƒˆ</option>
                            <option value="æ´¾é£">æ´¾é£</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-medium mb-2 block">ã“ã ã‚ã‚Šæ¡ä»¶</label>
                    <div class="flex flex-wrap gap-2" id="featureChips">
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="æ—¥å‹¤ã®ã¿" class="hidden"> æ—¥å‹¤ã®ã¿</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="å¤œå‹¤å°‚å¾“" class="hidden"> å¤œå‹¤å°‚å¾“</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="åœŸæ—¥ä¼‘ã¿" class="hidden"> åœŸæ—¥ä¼‘ã¿</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="æ®‹æ¥­å°‘ãªã‚" class="hidden"> æ®‹æ¥­å°‘ãªã‚</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="æœªçµŒé¨“å¯" class="hidden"> æœªçµŒé¨“å¯</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="ãƒ–ãƒ©ãƒ³ã‚¯å¯" class="hidden"> ãƒ–ãƒ©ãƒ³ã‚¯å¯</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="å¯®" class="hidden"> å¯®ãƒ»å€Ÿä¸Š</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="è¨—å…æ‰€" class="hidden"> è¨—å…æ‰€ã‚ã‚Š</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="è»Šé€šå‹¤" class="hidden"> è»Šé€šå‹¤å¯</label>
                        <label class="inline-flex items-center text-xs border border-gray-200 rounded-full px-3 py-1.5 cursor-pointer transition-all hover:border-primary hover:text-primary select-none"><input type="checkbox" name="feature" value="é§…è¿‘" class="hidden"> é§…è¿‘</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-4 pb-28">
        <div class="flex items-center justify-between mb-4">
            <p class="text-sm font-bold text-primary" id="resultCount"></p>
            <select id="sortSelect" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-primary/30 appearance-none pr-8" style="background-image:url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath fill=%27%23999%27 d=%27M5 7L1 3h8z%27/%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 8px center;">
                <option value="newest">æ–°ç€é †</option>
                <option value="salary_desc">å¹´åãŒé«˜ã„é †</option>
                <option value="salary_asc">å¹´åãŒä½ã„é †</option>
            </select>
        </div>
        <div id="topicsSection" class="hidden mb-4">
            <div class="bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl p-4 border border-pink-100">
                <div class="flex items-center gap-2 mb-3"><span class="text-lg">ğŸ”¥</span><h2 class="text-sm font-bold text-primary">ä»Šé€±ã®ãŠã™ã™ã‚æ±‚äºº</h2></div>
                <div id="topicsContainer" class="flex gap-3 overflow-x-auto hide-scrollbar pb-1"></div>
            </div>
        </div>
        <div id="jobsContainer" class="flex flex-col gap-4"></div>
    </main>

    <!-- Favorites Floating Bar -->
    <div id="cartBar" class="fixed bottom-5 left-1/2 -translate-x-1/2 translate-y-[100px] w-[90%] max-w-md bg-primary text-white px-5 py-4 rounded-full shadow-lg flex justify-between items-center z-[2000]" style="transform:translateX(-50%) translateY(100px);">
        <div class="font-bold text-base flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            <span>æ°—ã«ãªã‚‹æ±‚äºº</span>
            <span id="cartCount" class="bg-white text-primary px-2 py-0.5 rounded-full text-xs font-bold">0</span>
        </div>
        <button id="applyBtn" class="bg-white text-primary font-bold px-6 py-2.5 rounded-full shadow hover:bg-gray-50 active:scale-95 transition-all text-sm">ã¾ã¨ã‚ã¦å¿œå‹Ÿ</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const DATA_URL = './jobs.zip';
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwT4dlPuH3edMjF5aWRV_TgAzU0Rz7YS76Zb-H0Dv3G02ph0DR1KY006ldArCJZngFs/exec';
        const WORKER_API_URL = 'https://nijikango-jobs-api.t-kimura-business.workers.dev';
        let allJobs = [], cart = new Set(), currentFilteredJobs = [], currentPage = 1;
        const ITEMS_PER_PAGE = 20;
        const urlParams = new URLSearchParams(window.location.search);
        window.LINE_UID = urlParams.get('uid') || '';
        const REGION_PREF = {
            'é–¢æ±':['æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ'],
            'é–¢è¥¿':['å¤§é˜ªåºœ','å…µåº«çœŒ','äº¬éƒ½åºœ','å¥ˆè‰¯çœŒ','æ»‹è³€çœŒ','å’Œæ­Œå±±çœŒ'],
            'æ±æµ·':['æ„›çŸ¥çœŒ','é™å²¡çœŒ','å²é˜œçœŒ','ä¸‰é‡çœŒ'],
            'ä¹å·':['ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ'],
            'åŒ—æµ·é“ãƒ»æ±åŒ—':['åŒ—æµ·é“','é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ'],
            'ç”²ä¿¡è¶Šãƒ»åŒ—é™¸':['æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ','å±±æ¢¨çœŒ','é•·é‡çœŒ'],
            'ä¸­å›½ãƒ»å››å›½':['é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ','å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ']
        };
        function truncate(s,n){return s&&s.length>n?s.substring(0,n)+'...':s||'';}

        window.addEventListener('DOMContentLoaded',()=>{setupCart();setupFilters();setupInteractions();setupFeatureChips();fetchJobs();});

        // Cart
        function setupCart(){
            const saved=localStorage.getItem('nijikango_cart');
            if(saved){try{JSON.parse(saved).forEach(id=>cart.add(String(id)));updateCartUI();}catch(e){}}
            document.getElementById('applyBtn').addEventListener('click',applyBatch);
        }
        function toggleCart(id,btn){
            id=String(id);const icon=btn.querySelector('.heart-icon');
            if(cart.has(id)){cart.delete(id);btn.classList.remove('text-red-500');btn.classList.add('text-gray-300');if(icon)icon.setAttribute('fill','none');}
            else{cart.add(id);btn.classList.add('text-red-500');btn.classList.remove('text-gray-300');if(icon)icon.setAttribute('fill','currentColor');btn.classList.add('heart-pop');setTimeout(()=>btn.classList.remove('heart-pop'),300);}
            saveCart();updateCartUI();
        }
        function saveCart(){localStorage.setItem('nijikango_cart',JSON.stringify(Array.from(cart)));}
        function updateCartUI(){
            const c=cart.size;document.getElementById('cartCount').innerText=c;const bar=document.getElementById('cartBar');
            if(c>0){bar.style.transform='translateX(-50%) translateY(0)';bar.classList.add('cart-bar-enter');}
            else{bar.style.transform='translateX(-50%) translateY(100px)';bar.classList.remove('cart-bar-enter');}
        }

        // Modal
        function showApplyModal(){
            const c=cart.size;if(!c)return;
            const o=document.createElement('div');o.id='applyModal';o.className='fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]';
            o.innerHTML=`<div class="bg-white p-8 rounded-2xl text-center w-[90%] max-w-md shadow-2xl"><div class="text-gray-800 text-lg leading-relaxed mb-6">${c}ä»¶ã®æ±‚äººã«ã¾ã¨ã‚ã¦å¿œå‹Ÿã—ã¾ã™ã‹ï¼Ÿ</div><div class="flex justify-center gap-4"><button onclick="this.closest('#applyModal').remove()" class="px-6 py-3 rounded-full font-bold bg-gray-100 text-gray-600 min-w-[120px]">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onclick="this.closest('#applyModal').remove();executeApplyBatch();" class="px-6 py-3 rounded-full font-bold bg-primary text-white min-w-[120px]">å¿œå‹Ÿã™ã‚‹</button></div></div>`;
            document.body.appendChild(o);
        }
        function showResultModal(t){
            const e=document.getElementById('resultModal');if(e)e.remove();
            const o=document.createElement('div');o.id='resultModal';o.className='fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]';
            o.innerHTML=`<div class="bg-white p-8 rounded-2xl text-center w-[90%] max-w-md shadow-2xl"><div class="text-gray-800 text-lg leading-relaxed mb-6 whitespace-pre-wrap">${t}</div><button onclick="this.closest('#resultModal').remove()" class="px-6 py-3 rounded-full font-bold bg-primary text-white min-w-[120px]">é–‰ã˜ã‚‹</button></div>`;
            document.body.appendChild(o);
        }
        async function executeApplyBatch(){
            showResultModal('å¿œå‹ŸãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nLINEã«æ­£å¼ãªæ¡ˆå†…ã‚’ãŠé€ã‚Šã™ã‚‹ã®ã§ã€\nãƒˆãƒ¼ã‚¯ç”»é¢ã«æˆ»ã£ã¦ãŠå¾…ã¡ãã ã•ã„');
            const ids=Array.from(cart);cart.clear();saveCart();updateCartUI();
            document.querySelectorAll('.fav-btn').forEach(b=>{b.classList.remove('text-red-500');b.classList.add('text-gray-300');const i=b.querySelector('.heart-icon');if(i)i.setAttribute('fill','none');});
            try{fetch(GAS_API_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'apply_batch',userId:window.LINE_UID,jobIds:ids})}).catch(e=>console.error(e));}catch(e){}
        }
        async function applyBatch(){if(!cart.size)return;showApplyModal();}

        // Filters
        function setupFilters(){
            const reg=document.getElementById('regionInput'),pref=document.getElementById('prefSelect');
            reg.addEventListener('change',()=>{const r=reg.value;pref.innerHTML='<option value="">ã™ã¹ã¦ã®éƒ½é“åºœçœŒ</option>';if(r&&REGION_PREF[r]){REGION_PREF[r].forEach(p=>{const o=document.createElement('option');o.value=p;o.innerText=p;pref.appendChild(o);});pref.disabled=false;}else{pref.disabled=true;}});
        }
        function setupInteractions(){
            document.getElementById('searchBtn').addEventListener('click',()=>{currentPage=1;filterAndRender();});
            document.getElementById('sortSelect').addEventListener('change',()=>{currentPage=1;filterAndRender();});
            document.getElementById('keywordInput').addEventListener('keydown',e=>{if(e.key==='Enter'){currentPage=1;filterAndRender();}});
            const toggle=document.getElementById('filterToggleBtn'),detail=document.getElementById('detailFilters'),text=document.getElementById('filterToggleText');
            toggle.addEventListener('click',()=>{const h=detail.classList.contains('hidden');if(h){detail.classList.remove('hidden');detail.classList.add('animate-fade-in-up');text.textContent='é–‰ã˜ã‚‹';}else{detail.classList.add('hidden');detail.classList.remove('animate-fade-in-up');text.textContent='è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼';}});
        }
        function setupFeatureChips(){document.querySelectorAll('#featureChips label').forEach(l=>{l.addEventListener('click',()=>{const c=l.querySelector('input[type="checkbox"]');setTimeout(()=>{c.checked?l.classList.add('chip-active'):l.classList.remove('chip-active');},0);});});}

        // D1â†’æ—¥æœ¬èªã‚­ãƒ¼å¤‰æ›
        function mapD1ToDisplay(j){return{
            'æ±‚äººç•ªå·':j.job_number||'','æ±‚äººID':j.job_id||'','æ±‚äººã‚¿ã‚¤ãƒˆãƒ«':j.title||'','æ–½è¨­å':j.facility_name||'',
            'å¹´å':j.salary||'','æœˆçµ¦':j.monthly_salary||'','æ™‚çµ¦':j.hourly_salary||'','çµ¦ä¸å‚™è€ƒ':j.salary_note||'',
            'å„ç¨®æ‰‹å½“':j.allowance||'','è·ç¨®':j.job_type||'','é›‡ç”¨å½¢æ…‹':j.employment_type||'','æ–½è¨­å½¢æ…‹':j.facility_type||'',
            'å‹¤å‹™å½¢æ…‹':j.work_style||'','å‹¤å‹™æ™‚é–“':j.work_hours||'','ä¼‘æ—¥':j.holiday||'','æ‹…å½“æ¥­å‹™':j.duties||'',
            'æ¥­å‹™å†…å®¹':j.description||'','çµŒé¨“ãƒ»ã‚¹ã‚­ãƒ«':j.requirements||'','éƒ½é“åºœçœŒ':j.prefecture||'','å¸‚åŒºç”ºæ‘':j.city||'',
            'å‹¤å‹™åœ°':j.location||'','æœ€å¯„é§…ï¼ˆè·¯ç·šï¼‰':j.station||'','é€šå‹¤äº¤é€šè²»':j.commute||'','æ³•äººå':j.corporation||'',
            'è¨ºç™‚ç§‘ç›®':j.medical_dept||'','ç¦åˆ©åšç”Ÿ':j.benefits||'','ã‚¿ã‚°ï¼ˆç‰¹å¾´ï¼‰':j.tags||'','ç‰¹å¾´ã‚¿ã‚°':j.tags||'',
            'POINT1':j.point1||'','POINT2':j.point2||'','POINT3':j.point3||'','å–æNOTE':j.interview_note||'',
            'ãŠã™ã™ã‚æ±‚äºº':j.recommend_flag?'true':'false','å¹´åä¸‹é™':j.min_salary||0,'å¹´åä¸Šé™':j.max_salary||0,
            'è·ç¨®å¤§æ ':j.category||'','è·ç¨®è©³ç´°':j.detail||'','æ›´æ–°æ—¥':j.updated_at||''
        };}

        // Fetch Jobs (Worker APIå„ªå…ˆ â†’ zip fallback)
        async function fetchJobs(){
            try{
                // Strategy 1: Worker API (fast D1)
                try{
                    const res=await fetch(`${WORKER_API_URL}/api/jobs?limit=5000&t=${Date.now()}`);
                    if(res.ok){
                        const json=await res.json();
                        if(json.jobs&&json.jobs.length>0){
                            const data=json.jobs.map(mapD1ToDisplay);
                            allJobs=data;console.log(`Loaded ${data.length} jobs from Worker API`);
                            try{localStorage.setItem('jobs_cache',JSON.stringify({timestamp:Date.now(),data}));}catch(e){}
                            renderTopics(data);filterAndRender();return;
                        }
                    }
                }catch(e){console.warn('Worker API unavailable, falling back to zip:',e.message);}

                // Strategy 2: jobs.zip fallback
                const res=await fetch(`${DATA_URL}?t=${Date.now()}`);if(!res.ok)throw new Error('Not found');
                const blob=await res.blob();const zip=await JSZip.loadAsync(blob);
                const fn=Object.keys(zip.files).find(n=>n.endsWith('.json'));if(!fn)throw new Error('No JSON');
                const txt=await zip.files[fn].async('string');const data=JSON.parse(txt);
                if(Array.isArray(data)&&data.length>0){allJobs=data;try{localStorage.setItem('jobs_cache',JSON.stringify({timestamp:Date.now(),data}));}catch(e){}renderTopics(data);filterAndRender();}
                else{document.getElementById('jobsContainer').innerHTML='<div class="text-center py-10 text-gray-500 bg-white rounded-xl">æ±‚äººãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';}
            }catch(e){console.error(e);document.getElementById('jobsContainer').innerHTML='<div class="text-center py-10 text-red-500 bg-white rounded-xl">æ±‚äººãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';}
            finally{setTimeout(()=>{document.getElementById('loadingOverlay').style.display='none';},500);}
        }

        // Topics
        function renderTopics(jobs){
            let rec=jobs.filter(j=>{const f=String(j['ãŠã™ã™ã‚æ±‚äºº']||'').toLowerCase();return f==='true'||f==='1';});
            if(rec.length<3){const hi=jobs.filter(j=>parseInt(j['å¹´åä¸‹é™']||0)>=500&&!rec.includes(j));rec=[...rec,...hi];}
            if(rec.length<5){const s=new Set(rec);rec=[...rec,...[...jobs].reverse().filter(j=>!s.has(j))];}
            const final=rec.slice(0,5);if(!final.length)return;
            document.getElementById('topicsSection').classList.remove('hidden');
            document.getElementById('topicsContainer').innerHTML=final.map(j=>{
                const t=j['æ±‚äººã‚¿ã‚¤ãƒˆãƒ«']||'æ³¨ç›®ã®çœ‹è­·æ±‚äºº',s=j['å¹´å']||'å¿œç›¸è«‡',ft=j['æ–½è¨­å½¢æ…‹']||'',id=j['æ±‚äººç•ªå·']||j['æ±‚äººID'];
                return `<a href="detail.html?id=${id}&uid=${window.LINE_UID}" class="flex-shrink-0 w-64 bg-white rounded-xl p-4 shadow-sm border border-pink-100 hover:shadow-md transition-shadow no-underline">${ft?`<span class="text-xs bg-primary-light text-primary px-2 py-0.5 rounded font-medium">${ft}</span>`:''}<div class="text-sm font-bold text-gray-800 mt-2 leading-snug line-clamp-2">${truncate(t,30)}</div><div class="text-xs text-primary font-bold mt-2">ğŸ’° ${s}</div></a>`;
            }).join('');
        }

        // Filter & Render
        function filterAndRender(){
            const kw=document.getElementById('keywordInput').value.trim().toLowerCase();
            const region=document.getElementById('regionInput').value;
            const pref=document.getElementById('prefSelect').value;
            const cat=document.getElementById('categoryInput').value;
            const minSal=parseInt(document.getElementById('salaryInput').value,10);
            const emp=document.getElementById('employmentInput').value;
            const sort=document.getElementById('sortSelect').value;
            const feats=Array.from(document.querySelectorAll('input[name="feature"]:checked')).map(c=>c.value);

            let filtered=allJobs.filter(j=>{
                const loc=(j['å‹¤å‹™åœ°']||'')+(j['éƒ½é“åºœçœŒ']||'')+(j['å¸‚åŒºç”ºæ‘']||'');
                const jCat=(j['æ–½è¨­å½¢æ…‹']||j['è·ç¨®å¤§æ ']||'');
                const jSal=parseInt(j['å¹´åä¸‹é™']||0);
                const jFeat=(j['ç‰¹å¾´ã‚¿ã‚°']||'')+(j['ã‚¿ã‚°ï¼ˆç‰¹å¾´ï¼‰']||'');
                const jEmp=(j['é›‡ç”¨å½¢æ…‹']||'');
                if(kw){const txt=[j['æ±‚äººã‚¿ã‚¤ãƒˆãƒ«'],j['æ–½è¨­å½¢æ…‹'],j['è·ç¨®'],j['æ¥­å‹™å†…å®¹'],j['å‹¤å‹™åœ°'],j['éƒ½é“åºœçœŒ'],j['æ–½è¨­å'],j['ã‚¿ã‚°ï¼ˆç‰¹å¾´ï¼‰'],j['ç‰¹å¾´ã‚¿ã‚°'],j['é›‡ç”¨å½¢æ…‹']].join(' ').toLowerCase();if(!txt.includes(kw))return false;}
                if(region){if(pref){if(!loc.includes(pref))return false;}else{const ps=REGION_PREF[region]||[];if(!ps.some(p=>loc.includes(p)))return false;}}
                if(cat&&!jCat.includes(cat))return false;
                if(minSal>0&&jSal<minSal)return false;
                if(emp&&!jEmp.includes(emp))return false;
                if(feats.length>0&&!feats.every(f=>jFeat.includes(f)))return false;
                return true;
            });
            if(sort==='salary_desc')filtered.sort((a,b)=>parseInt(b['å¹´åä¸‹é™']||0)-parseInt(a['å¹´åä¸‹é™']||0));
            else if(sort==='salary_asc')filtered.sort((a,b)=>parseInt(a['å¹´åä¸‹é™']||0)-parseInt(b['å¹´åä¸‹é™']||0));
            currentFilteredJobs=filtered;
            document.getElementById('resultCount').textContent=`${filtered.length}ä»¶ã®æ±‚äºº`;
            renderPage();
        }

        function renderPage(){
            const con=document.getElementById('jobsContainer');
            const tp=Math.ceil(currentFilteredJobs.length/ITEMS_PER_PAGE);
            const start=(currentPage-1)*ITEMS_PER_PAGE;
            const page=currentFilteredJobs.slice(start,start+ITEMS_PER_PAGE);
            if(!page.length){con.innerHTML='<div class="text-center py-10 text-gray-500 bg-white rounded-xl">æ¡ä»¶ã«åˆã†æ±‚äººãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';return;}
            con.innerHTML=page.map((j,i)=>{
                const id=j['æ±‚äººç•ªå·']||j['æ±‚äººID'],title=j['æ±‚äººã‚¿ã‚¤ãƒˆãƒ«']||'æ±‚äºº',fac=j['æ–½è¨­å']||'éå…¬é–‹';
                const salary=j['å¹´å']||'å¿œç›¸è«‡',loc=truncate((j['éƒ½é“åºœçœŒ']||'')+(j['å¸‚åŒºç”ºæ‘']||'')+' '+(j['æœ€å¯„é§…ï¼ˆè·¯ç·šï¼‰']||''),25);
                const ft=j['æ–½è¨­å½¢æ…‹']||'',emp=j['é›‡ç”¨å½¢æ…‹']||'';
                const feats=(j['ç‰¹å¾´ã‚¿ã‚°']||j['ã‚¿ã‚°ï¼ˆç‰¹å¾´ï¼‰']||'').split(',').filter(Boolean).slice(0,3);
                if(ft)feats.unshift(ft);
                const desc=truncate(j['æ¥­å‹™å†…å®¹']||j['æ‹…å½“æ¥­å‹™']||'',60);
                const inCart=cart.has(String(id));
                const tags=feats.map(t=>t===ft?`<span class="text-xs px-2 py-0.5 rounded bg-primary-light text-primary">${t}</span>`:`<span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-600">${t}</span>`).join('');
                return `<div class="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow animate-fade-in-up" style="animation-delay:${i*30}ms"><a href="detail.html?id=${id}&uid=${window.LINE_UID}" class="block p-4 no-underline text-inherit"><div class="flex items-center justify-between mb-2"><span class="text-xs text-gray-400">No.${id}</span>${emp?`<span class="text-xs text-gray-500 border border-gray-200 rounded px-1.5 py-0.5">${emp}</span>`:''}</div><div class="text-sm font-bold text-gray-700 mb-1">${fac}</div><h3 class="text-base font-bold text-primary leading-snug mb-3">${title}</h3><div class="flex flex-wrap gap-1.5 mb-3">${tags}</div>${desc?`<p class="text-xs text-gray-500 mb-3 line-clamp-2 leading-relaxed">${desc}</p>`:''}<div class="flex items-center gap-4 text-sm text-gray-600"><span class="flex items-center gap-1">ğŸ“ ${loc||'---'}</span><span class="flex items-center gap-1 font-bold text-primary">ğŸ’° ${salary}</span></div></a><div class="px-4 pb-3 flex items-center justify-between border-t border-gray-50 pt-2"><button class="fav-btn ${inCart?'text-red-500':'text-gray-300'} hover:scale-110 transition-transform p-1" onclick="event.stopPropagation();toggleCart('${id}',this)"><svg class="w-6 h-6 heart-icon" fill="${inCart?'currentColor':'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg></button><a href="detail.html?id=${id}&uid=${window.LINE_UID}" class="text-xs text-primary font-medium hover:underline">è©³ç´°ã‚’è¦‹ã‚‹ â†’</a></div></div>`;
            }).join('');
            if(tp>1){con.innerHTML+=`<div class="flex justify-center items-center gap-4 mt-6"><button onclick="changePage(-1)" ${currentPage<=1?'disabled':''} class="px-5 py-2.5 rounded-full font-bold text-sm ${currentPage<=1?'bg-gray-100 text-gray-400':'bg-white text-gray-700 shadow-sm hover:shadow-md'} transition-shadow">â† å‰ã¸</button><span class="text-sm text-gray-500 font-bold">${currentPage} / ${tp}</span><button onclick="changePage(1)" ${currentPage>=tp?'disabled':''} class="px-5 py-2.5 rounded-full font-bold text-sm ${currentPage>=tp?'bg-gray-100 text-gray-400':'bg-white text-gray-700 shadow-sm hover:shadow-md'} transition-shadow">æ¬¡ã¸ â†’</button></div>`;}
        }
        function changePage(d){const tp=Math.ceil(currentFilteredJobs.length/ITEMS_PER_PAGE);currentPage=Math.max(1,Math.min(tp,currentPage+d));renderPage();window.scrollTo({top:0,behavior:'smooth'});}
    </script>
</body>
</html>
