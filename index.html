<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>æ±‚äººæ¤œç´¢ - ãƒ‹ã‚¸çœ‹è­·</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../survey/styles.css">
    <style>
        /* CSS Variables Override/Addition */
        :root {
            --color-bg-light: #f9f9f9;
        }

        body {
            background-color: var(--color-bg-light);
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Topics Carousel */
        .topics-section {
            padding: var(--spacing-md);
            overflow: hidden;
            background: white;
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text);
        }

        .topics-scroll {
            display: flex;
            gap: var(--spacing-md);
            overflow-x: auto;
            padding-bottom: var(--spacing-sm);
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .topic-card {
            flex: 0 0 85%;
            scroll-snap-align: center;
            background: linear-gradient(135deg, var(--color-accent) 0%, #ff9ebb 100%);
            color: white;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: block;
        }

        .topic-card::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
            transform: rotate(45deg);
        }

        .topic-badge {
            background: rgba(0, 0, 0, 0.2);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: inline-block;
            font-weight: bold;
        }

        .topic-title {
            font-weight: bold;
            font-size: 1.1rem;
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .topic-salary {
            font-size: 0.9rem;
            opacity: 0.95;
            margin-top: 4px;
        }

        /* Search Section */
        .search-area {
            background: white;
            margin: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md);
        }

        .search-header {
            font-weight: bold;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .filter-grid {
            display: grid;
            gap: var(--spacing-md);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 0.85rem;
            color: var(--color-text-light);
            font-weight: bold;
        }

        .filter-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #fff;
        }

        .checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            color: #555;
            padding: 4px 8px;
            border: 1px solid #eee;
            border-radius: 16px;
            background: #f9f9f9;
            cursor: pointer;
        }

        .checkbox-label:has(input:checked) {
            background: var(--color-accent-light);
            border-color: var(--color-accent);
            color: var(--color-accent);
            font-weight: 500;
        }

        .search-btn {
            width: 100%;
            padding: 12px;
            background: var(--color-text);
            color: white;
            border-radius: 8px;
            font-weight: bold;
            margin-top: var(--spacing-sm);
            transition: opacity 0.2s;
        }

        .search-btn:active {
            opacity: 0.8;
        }

        /* Sort Bar */
        .sort-bar {
            padding: 0 var(--spacing-md) var(--spacing-sm);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
        }

        .sort-select {
            padding: 6px 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            font-size: 0.85rem;
            background: white;
        }

        /* Job List */
        .jobs-container {
            padding: 0 var(--spacing-md) 80px;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .job-card {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid transparent;
            text-decoration: none;
            color: inherit;
            display: block;
            transition: transform 0.2s ease;
        }

        .job-card:active {
            transform: scale(0.98);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-text-light);
            margin-bottom: 8px;
        }

        .company-name {
            font-weight: bold;
            color: var(--color-text);
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .job-title {
            font-weight: bold;
            font-size: 1.05rem;
            color: var(--color-accent);
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .tag {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: #f0f0f0;
            color: #555;
        }

        .tag.accent {
            background: var(--color-accent-light);
            color: var(--color-accent);
        }

        .features-preview {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .job-meta {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px 10px;
            font-size: 0.85rem;
            color: #555;
        }

        /* Cute Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .cute-loader {
            width: 60px;
            height: 60px;
            background-color: var(--color-accent);
            border-radius: 50%;
            animation: bounce 1.0s infinite ease-in-out;
            position: relative;
        }

        .cute-loader::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 12px;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
        }

        .cute-loader::after {
            content: '';
            position: absolute;
            top: 15px;
            right: 12px;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
        }

        .loader-text {
            margin-top: 20px;
            color: var(--color-accent);
            font-weight: bold;
            font-size: 1.1rem;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(0.0);
                -webkit-transform: scale(0.0);
            }

            50% {
                transform: scale(1.0);
                -webkit-transform: scale(1.0);
            }
        }

        .error-msg {
            color: var(--color-error);
            text-align: center;
            padding: 20px;
            background: #fff;
            margin: 20px;
            border-radius: 8px;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            align-items: center;
        }

        .page-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: var(--color-text);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #eee;
        }

        .page-info {
            font-size: 0.9rem;
            color: #666;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="cute-loader"></div>
        <div class="loader-text">æ±‚äººã‚’æ¢ã—ã¦ã„ã¾ã™...</div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header__logo">
                <span style="font-weight:bold; font-size:1.2rem; color:var(--color-accent);">ãƒ‹ã‚¸çœ‹è­·æ±‚äºº</span>
            </div>
        </header>

        <!-- Topics Carousel (Recommended) -->
        <section class="topics-section">
            <div class="section-title">
                <span>ğŸ”¥</span> ä»Šé€±ã®ãŠã™ã™ã‚æ±‚äººï¼
            </div>
            <div class="topics-scroll" id="topicsContainer">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Search Filter (Visible) -->
        <div class="search-area">
            <div class="search-header">ğŸ” æ¡ä»¶æ¤œç´¢</div>

            <div class="filter-grid">
                <!-- è·ç¨®å¤§æ  -->
                <div class="filter-group">
                    <label class="filter-label">è·ç¨® (å¤§æ )</label>
                    <select id="categoryInput" class="filter-input">
                        <option value="">ã™ã¹ã¦ã®è·ç¨®</option>
                        <option value="å–¶æ¥­">å–¶æ¥­</option>
                        <option value="äº‹å‹™ãƒ»ç®¡ç†">äº‹å‹™ãƒ»ç®¡ç†</option>
                        <option value="ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢">ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢</option>
                        <option value="ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–">ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–</option>
                        <option value="ä¼ç”»ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°">ä¼ç”»ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°</option>
                        <option value="ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ">ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ</option>
                        <option value="ã‚µãƒ¼ãƒ“ã‚¹ãƒ»è²©å£²">ã‚µãƒ¼ãƒ“ã‚¹ãƒ»è²©å£²</option>
                        <option value="Webãƒ»ãƒ‡ãƒ¼ã‚¿åˆ†æ">Webãƒ»ãƒ‡ãƒ¼ã‚¿åˆ†æ</option>
                    </select>
                </div>

                <!-- è·ç¨®è©³ç´° -->
                <div class="filter-group">
                    <label class="filter-label">è·ç¨® (è©³ç´°)</label>
                    <select id="detailSelect" class="filter-input" disabled>
                        <option value="">å…ˆã«å¤§æ ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <!-- ã‚¨ãƒªã‚¢ï¼ˆå¤§æ ï¼‰ -->
                <div class="filter-group">
                    <label class="filter-label">ã‚¨ãƒªã‚¢ (å¤§æ )</label>
                    <select id="regionInput" class="filter-input">
                        <option value="">ã™ã¹ã¦ã®ã‚¨ãƒªã‚¢</option>
                        <option value="é–¢æ±">é–¢æ±</option>
                        <option value="é–¢è¥¿">é–¢è¥¿</option>
                        <option value="æ±æµ·">æ±æµ·</option>
                        <option value="ä¹å·">ä¹å·ãƒ»æ²–ç¸„</option>
                        <option value="åŒ—æµ·é“ãƒ»æ±åŒ—">åŒ—æµ·é“ãƒ»æ±åŒ—</option>
                        <option value="ç”²ä¿¡è¶Šãƒ»åŒ—é™¸">ç”²ä¿¡è¶Šãƒ»åŒ—é™¸</option>
                        <option value="ä¸­å›½ãƒ»å››å›½">ä¸­å›½ãƒ»å››å›½</option>
                        <option value="ãƒªãƒ¢ãƒ¼ãƒˆ">ãƒªãƒ¢ãƒ¼ãƒˆ</option>
                    </select>
                </div>

                <!-- éƒ½é“åºœçœŒ (è©³ç´°) -->
                <div class="filter-group">
                    <label class="filter-label">éƒ½é“åºœçœŒ (è©³ç´°)</label>
                    <select id="prefSelect" class="filter-input" disabled>
                        <option value="">å…ˆã«ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <!-- å¹´å -->
                <div class="filter-group">
                    <label class="filter-label">æœ€ä½å¹´å</label>
                    <select id="salaryInput" class="filter-input">
                        <option value="0">ã“ã ã‚ã‚‰ãªã„</option>
                        <option value="300">300ä¸‡å††ä»¥ä¸Š</option>
                        <option value="400">400ä¸‡å††ä»¥ä¸Š</option>
                        <option value="500">500ä¸‡å††ä»¥ä¸Š</option>
                        <option value="600">600ä¸‡å††ä»¥ä¸Š</option>
                        <option value="700">700ä¸‡å††ä»¥ä¸Š</option>
                        <option value="800">800ä¸‡å††ä»¥ä¸Š</option>
                    </select>
                </div>

                <!-- ç‰¹å¾´ -->
                <div class="filter-group">
                    <label class="filter-label">ç‰¹å¾´ (è¤‡æ•°é¸æŠå¯)</label>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <label class="checkbox-label"><input type="checkbox" name="feature" value="å®Œå…¨æœªçµŒé¨“OK">
                            å®Œå…¨æœªçµŒé¨“OK</label>
                        <label class="checkbox-label"><input type="checkbox" name="feature" value="è·ç¨®æœªçµŒé¨“OK">
                            è·ç¨®æœªçµŒé¨“OK</label>
                        <label class="checkbox-label"><input type="checkbox" name="feature" value="æ¥­ç¨®æœªçµŒé¨“OK">
                            æ¥­ç¨®æœªçµŒé¨“OK</label>
                        <label class="checkbox-label"><input type="checkbox" name="feature" value="åœŸæ—¥ä¼‘ã¿"> åœŸæ—¥ä¼‘ã¿</label>
                        <label class="checkbox-label"><input type="checkbox" name="feature" value="è»¢å‹¤ãªã—"> è»¢å‹¤ãªã—</label>
                        <label class="checkbox-label"><input type="checkbox" name="feature" value="ç”£ä¼‘è‚²ä¼‘å®Ÿç¸¾ã‚ã‚Š">
                            ç”£ä¼‘è‚²ä¼‘å®Ÿç¸¾ã‚ã‚Š</label>
                        <label class="checkbox-label"><input type="checkbox" name="feature" value="æ®‹æ¥­ãªã—"> æ®‹æ¥­ãªã—</label>
                        <label class="checkbox-label"><input type="checkbox" name="feature" value="ç¤¾å®…å®¶è³ƒè£œåŠ©åˆ¶åº¦ã‚ã‚Š">
                            ç¤¾å®…/å®¶è³ƒè£œåŠ©</label>
                    </div>
                </div>

                <button class="search-btn" id="searchBtn">ã“ã®æ¡ä»¶ã§æ¤œç´¢ã™ã‚‹</button>
            </div>
        </div>

        <!-- Sort Bar -->
        <div class="sort-bar">
            <span>ä¸¦ã³æ›¿ãˆ:</span>
            <select id="sortSelect" class="sort-select">
                <option value="newest">æ–°ç€é †</option>
                <option value="salary_desc">å¹´åãŒé«˜ã„é †</option>
                <option value="salary_asc">å¹´åãŒä½ã„é †</option>
            </select>
        </div>

        <!-- Job List -->
        <div class="jobs-container" id="jobsContainer">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- JSZip for client-side unzipping -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Script -->
    <script>
        const DATA_URL = './jobs.zip';
        let allJobs = [];

        let currentFilteredJobs = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 20;

        /**
         * è·ç¨®ãƒãƒƒãƒ”ãƒ³ã‚°
         */
        const JOB_DETAILS = {
            "å–¶æ¥­": ["æ³•äººå–¶æ¥­", "å€‹äººå–¶æ¥­", "ãƒ«ãƒ¼ãƒˆå–¶æ¥­", "ä¼ç”»å–¶æ¥­", "æŠ€è¡“å–¶æ¥­ãƒ»ã‚»ãƒ¼ãƒ«ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", "äººæç³»å–¶æ¥­", "åŒ»ç™‚ç³»å–¶æ¥­", "ä¿é™ºå–¶æ¥­", "ä¸å‹•ç”£å–¶æ¥­", "ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ã‚»ãƒ¼ãƒ«ã‚¹", "å–¶æ¥­äº‹å‹™ãƒ»ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ", "ãã®ä»–ï¼ˆå–¶æ¥­ï¼‰"],
            "äº‹å‹™ãƒ»ç®¡ç†": ["ä¸€èˆ¬äº‹å‹™", "çµŒç†ãƒ»è²¡å‹™", "äººäº‹ãƒ»åŠ´å‹™ãƒ»æ¡ç”¨", "ç·å‹™", "ç§˜æ›¸ãƒ»å—ä»˜", "æ³•å‹™ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹", "è³¼è²·ãƒ»èª¿é”", "è²¿æ˜“äº‹å‹™", "ã‚³ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼é‹å–¶", "ãã®ä»–ï¼ˆäº‹å‹™ãƒ»ç®¡ç†ï¼‰"],
            "ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢": ["SEãƒ»ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼", "ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", "ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", "ç¤¾å†…SE", "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ", "ITé‹ç”¨ãƒ»ä¿å®ˆ", "ãƒ†ã‚¹ãƒˆãƒ»å“è³ªä¿è¨¼", "ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚µãƒãƒ¼ãƒˆ", "ãã®ä»–ï¼ˆITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼‰"],
            "ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–": ["ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼", "Webãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼", "Webãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼", "Webãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼", "ã‚¢ãƒ‘ãƒ¬ãƒ«ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼", "åºƒå‘Šãƒ»PRãƒ»ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³", "ãã®ä»–ï¼ˆã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ï¼‰"],
            "ä¼ç”»ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°": ["çµŒå–¶ä¼ç”»", "äº‹æ¥­ä¼ç”»", "æ–°è¦äº‹æ¥­é–‹ç™º", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "Webãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "åºƒå ±ãƒ»PR", "ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ»ç®¡ç†è·", "ãã®ä»–ï¼ˆä¼ç”»ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ï¼‰"],
            "ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ": ["çµŒå–¶ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ", "æˆ¦ç•¥ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ", "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ", "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ", "äººæã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚¿ãƒ¼", "ãã®ä»–ï¼ˆã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆï¼‰"],
            "ã‚µãƒ¼ãƒ“ã‚¹ãƒ»è²©å£²": ["è²©å£²ã‚¹ã‚¿ãƒƒãƒ•", "ã‚¢ãƒ‘ãƒ¬ãƒ«è²©å£²", "åº—é•·ãƒ»SV", "ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒ¼ãƒ“ã‚¹", "ãƒ›ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒãƒ•", "ãã®ä»–ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ»è²©å£²ï¼‰"],
            "Webãƒ»ãƒ‡ãƒ¼ã‚¿åˆ†æ": ["ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ãƒ†ã‚£ã‚¹ãƒˆ", "ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆ", "Webã‚µãƒ¼ãƒ“ã‚¹ä¼ç”»", "ãã®ä»–ï¼ˆWebãƒ»ãƒ‡ãƒ¼ã‚¿åˆ†æï¼‰"]
        };

        /**
         * åœ°åŸŸãƒãƒƒãƒ”ãƒ³ã‚°
         */
        const REGION_PREF = {
            "é–¢æ±": ["æ±äº¬", "ç¥å¥ˆå·", "åƒè‘‰", "åŸ¼ç‰", "èŒ¨åŸ", "æ ƒæœ¨", "ç¾¤é¦¬"],
            "é–¢è¥¿": ["å¤§é˜ª", "äº¬éƒ½", "å…µåº«", "å¥ˆè‰¯", "æ»‹è³€", "å’Œæ­Œå±±"],
            "æ±æµ·": ["æ„›çŸ¥", "é™å²¡", "å²é˜œ", "ä¸‰é‡"],
            "ä¹å·": ["ç¦å²¡", "ä½è³€", "é•·å´", "ç†Šæœ¬", "å¤§åˆ†", "å®®å´", "é¹¿å…å³¶", "æ²–ç¸„"],
            "åŒ—æµ·é“ãƒ»æ±åŒ—": ["åŒ—æµ·é“", "é’æ£®", "å²©æ‰‹", "å®®åŸ", "ç§‹ç”°", "å±±å½¢", "ç¦å³¶"],
            "ç”²ä¿¡è¶Šãƒ»åŒ—é™¸": ["æ–°æ½Ÿ", "å¯Œå±±", "çŸ³å·", "ç¦äº•", "å±±æ¢¨", "é•·é‡"],
            "ä¸­å›½ãƒ»å››å›½": ["é³¥å–", "å³¶æ ¹", "å²¡å±±", "åºƒå³¶", "å±±å£", "å¾³å³¶", "é¦™å·", "æ„›åª›", "é«˜çŸ¥"],
            "ãƒªãƒ¢ãƒ¼ãƒˆ": ["ãƒªãƒ¢ãƒ¼ãƒˆ"]
        };

        window.addEventListener('DOMContentLoaded', () => {
            // Check URL params for uid to pass it later
            const params = new URLSearchParams(window.location.search);
            window.LINE_UID = params.get('uid') || '';

            fetchJobs();
            setupInteractions();
            setupFilters();
        });

        function setupFilters() {
            // Category -> Detail
            const catSelect = document.getElementById('categoryInput');
            const detailSelect = document.getElementById('detailSelect');
            catSelect.addEventListener('change', () => {
                const cat = catSelect.value;
                detailSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®è©³ç´°è·ç¨®</option>';
                if (cat && JOB_DETAILS[cat]) {
                    JOB_DETAILS[cat].forEach(detail => {
                        const opt = document.createElement('option');
                        opt.value = detail;
                        opt.innerText = detail;
                        detailSelect.appendChild(opt);
                    });
                    detailSelect.disabled = false;
                } else {
                    detailSelect.disabled = true;
                }
            });

            // Region -> Pref
            const regSelect = document.getElementById('regionInput');
            const prefSelect = document.getElementById('prefSelect');
            regSelect.addEventListener('change', () => {
                const reg = regSelect.value;
                prefSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®éƒ½é“åºœçœŒ</option>';
                if (reg && REGION_PREF[reg]) {
                    REGION_PREF[reg].forEach(pref => {
                        const opt = document.createElement('option');
                        opt.value = pref;
                        opt.innerText = pref;
                        prefSelect.appendChild(opt);
                    });
                    prefSelect.disabled = false;
                } else {
                    prefSelect.disabled = true;
                }
            });
        }

        async function fetchJobs() {
            try {
                // Try from localStorage first (optional, but good for refresh)
                // Actually cache logic is mainly for detail page, but index can use it too
                // For now, index logic: fetch zip always to ensure fresh data, then SAVE to cache

                const res = await fetch(`${DATA_URL}?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error('Local data not found');

                const blob = await res.blob();
                const zip = await JSZip.loadAsync(blob);
                const jsonFileName = Object.keys(zip.files).find(name => name.endsWith('.json'));
                if (!jsonFileName) throw new Error('No JSON found');

                const jsonText = await zip.files[jsonFileName].async('string');
                const data = JSON.parse(jsonText);

                if (Array.isArray(data)) {
                    allJobs = data;

                    // Save to Cache for Detail Page
                    try {
                        localStorage.setItem('jobs_cache', JSON.stringify({
                            timestamp: new Date().getTime(),
                            data: data
                        }));
                    } catch (e) { console.warn('Cache limit', e); }

                    renderTopics(data);
                    filterAndRender();
                }
            } catch (e) {
                console.error(e);
                document.getElementById('jobsContainer').innerHTML = '<p class="error-msg">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            } finally {
                // Hide Loader
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 500);
            }
        }

        function renderTopics(jobs) {
            let recommended = jobs.filter(j => {
                const flag = String(j['ãŠã™ã™ã‚æ±‚äºº'] || '').toLowerCase();
                return flag === 'true' || flag === '1' || flag === 'yes' || flag === 'ãŠã™ã™ã‚';
            });

            if (recommended.length < 3) {
                const highSalary = jobs.filter(j =>
                    parseInt(j['å¹´åä¸‹é™'] || 0) >= 600 && !recommended.includes(j)
                );
                recommended = [...recommended, ...highSalary];
            }

            if (recommended.length < 5) {
                const recSet = new Set(recommended);
                const newArrivals = [...jobs].reverse().filter(j => !recSet.has(j));
                recommended = [...recommended, ...newArrivals];
            }

            const finalRecs = recommended.slice(0, 5);

            const container = document.getElementById('topicsContainer');
            if (finalRecs.length === 0) {
                container.innerHTML = '<p style="padding:10px; color:#888;">æº–å‚™ä¸­</p>';
                return;
            }

            container.innerHTML = finalRecs.map(job => {
                const title = job['æ±‚äººã‚¿ã‚¤ãƒˆãƒ«'] || 'æ³¨ç›®æ±‚äºº';
                const salary = job['å¹´å'] || 'å¿œç›¸è«‡';
                const id = job['æ±‚äººç•ªå·'] || job['æ±‚äººID'];

                // New Tab for Topics too
                return `
                    <a href="detail.html?id=${id}&uid=${window.LINE_UID}" target="_blank" class="topic-card">
                        <span class="topic-badge">WEEKLY PICKUP</span>
                        <div class="topic-title">${truncate(title, 30)}</div>
                        <div class="topic-salary">ğŸ’° ${salary}</div>
                    </a>
                `;
            }).join('');
        }

        function filterAndRender() {
            // Dropdowns
            const region = document.getElementById('regionInput').value;
            const pref = document.getElementById('prefSelect').value;
            const category = document.getElementById('categoryInput').value;
            const detail = document.getElementById('detailSelect').value;
            const minSalary = parseInt(document.getElementById('salaryInput').value, 10);
            const sortMode = document.getElementById('sortSelect').value;

            // Checkboxes
            const checkedFeatures = Array.from(document.querySelectorAll('input[name="feature"]:checked'))
                .map(cb => cb.value);

            let filtered = allJobs.filter(job => {
                const jDetail = (job['è·ç¨®è©³ç´°'] || '');
                const jPref = (job['å‹¤å‹™åœ°'] || ''); // Assuming Pref is in Location
                const jCat = (job['è·ç¨®å¤§æ '] || '');
                const jSalMin = parseInt(job['å¹´åä¸‹é™'] || 0);
                const jFeatures = (job['ç‰¹å¾´ã‚¿ã‚°'] || '');

                // Region Logic: Simple include check for prefecture is easy, 
                // but for region check we can use the REGION_PREF map if needed?
                // Actually usually location string contains prefecture.
                // If "é–¢æ±" selected, we check if location includes any of Tokyo, Kanagawa...
                if (region) {
                    if (pref) {
                        // Specific Pref selected
                        if (!jPref.includes(pref)) return false;
                    } else {
                        // Region selected -> check if valid prefs in this region
                        const validPrefs = REGION_PREF[region] || [];
                        const match = validPrefs.some(p => jPref.includes(p));
                        if (!match) return false;
                    }
                }

                if (category && !jCat.includes(category)) return false;
                if (detail && !jDetail.includes(detail)) return false;
                if (minSalary > 0 && jSalMin < minSalary) return false;

                if (checkedFeatures.length > 0) {
                    for (const f of checkedFeatures) {
                        if (!jFeatures.includes(f)) return false;
                    }
                }

                return true;
            });

            // Sort
            if (sortMode === 'salary_desc') {
                filtered.sort((a, b) => (parseInt(b['å¹´åä¸‹é™'] || 0) - parseInt(a['å¹´åä¸‹é™'] || 0)));
            } else if (sortMode === 'salary_asc') {
                filtered.sort((a, b) => (parseInt(a['å¹´åä¸‹é™'] || 0) - parseInt(b['å¹´åä¸‹é™'] || 0)));
            } else {
                filtered.reverse();
            }

            currentFilteredJobs = filtered;
            currentPage = 1;

            const container = document.getElementById('jobsContainer');
            container.innerHTML = '';
            renderPage();
        }

        function renderPage() {
            const container = document.getElementById('jobsContainer');
            container.innerHTML = ''; // Clear current items

            if (currentFilteredJobs.length === 0) {
                container.innerHTML = '<div class="loading">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                return;
            }

            const totalPages = Math.ceil(currentFilteredJobs.length / ITEMS_PER_PAGE);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = currentFilteredJobs.slice(start, end);

            const html = pageItems.map(job => {
                const id = job['æ±‚äººç•ªå·'] || job['æ±‚äººID'];
                const title = job['æ±‚äººã‚¿ã‚¤ãƒˆãƒ«'] || 'æ±‚äººè©³ç´°';
                
                // æ–½è¨­æƒ…å ±ï¼ˆæ–°CSVå¯¾å¿œï¼‰
                const facilityName = job['æ–½è¨­å'] || job['ä¼æ¥­å'] || 'éå…¬é–‹æ–½è¨­';
                const facilityType = job['æ–½è¨­å½¢æ…‹'] || '';
                
                // å‹¤å‹™åœ°ï¼ˆéƒ½é“åºœçœŒ+å¸‚åŒºç”ºæ‘ï¼‰
                const prefecture = job['éƒ½é“åºœçœŒ'] || '';
                const city = job['å¸‚åŒºç”ºæ‘'] || '';
                const location = prefecture && city ? `${prefecture}${city}` : (job['å‹¤å‹™åœ°'] || '-');
                
                // çµ¦ä¸ï¼ˆå¹´åå„ªå…ˆã€æœˆçµ¦ãƒ»æ™‚çµ¦ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                const salary = job['å¹´å'] || job['æœˆçµ¦'] || job['æ™‚çµ¦'] || '-';
                
                // è·ç¨®
                const jobType = job['è·ç¨®'] || job['è·ç¨®å¤§æ '] || '';

                // ã‚¿ã‚°ï¼ˆæ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€Œã‚¿ã‚°ï¼ˆç‰¹å¾´ï¼‰ã€ã‚’å„ªå…ˆï¼‰
                const tagsRaw = job['ã‚¿ã‚°ï¼ˆç‰¹å¾´ï¼‰'] || job['ç‰¹å¾´ã‚¿ã‚°'] || '';
                const tagList = tagsRaw.split(',').filter(Boolean).map(t => t.trim());
                const tagHtml = tagList.slice(0, 3).map(t => `<span class="tag">${t}</span>`).join('');

                // POINT1-3ï¼ˆãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆï¼‰
                const point1 = job['POINT1'] || '';
                const point2 = job['POINT2'] || '';
                const point3 = job['POINT3'] || '';
                const points = [point1, point2, point3].filter(Boolean);
                const pointsPreview = points.length > 0 ? points[0] : '';

                // ãŠã™ã™ã‚ãƒãƒƒã‚¸
                const isRec = (String(job['ãŠã™ã™ã‚æ±‚äºº'] || '').match(/true|1|ãŠã™ã™ã‚/i));
                const recBadge = isRec ? `<span class="tag accent" style="background:#ffd700; color:#333;">â˜…ãŠã™ã™ã‚</span>` : '';
                const facilityBadge = facilityType ? `<span class="tag accent" style="background:#e3f2fd; color:#1976d2;">${facilityType}</span>` : '';

                return `
                    <a href="detail.html?id=${id}&uid=${window.LINE_UID}" target="_blank" class="job-card">
                        <div class="job-header">
                            <span>No.${id}</span>
                            <span>${truncate(location, 12)}</span>
                        </div>
                        <div class="company-name">${facilityName}</div>
                        <div class="job-title">${title}</div>
                        <div class="tag-list">
                            ${recBadge}
                            ${facilityBadge}
                            ${tagHtml}
                        </div>
                        ${pointsPreview ? `<div class="features-preview">
                           <b>âœ¨ </b>${pointsPreview}
                        </div>` : ''}
                        <div class="job-meta">
                            <span>ğŸ’°</span><span>${salary}</span>
                            <span>ğŸ‘¨â€âš•ï¸</span><span>${truncate(jobType, 18)}</span>
                        </div>
                    </a>
                `;
            }).join('');

            container.innerHTML = html;
            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            const container = document.getElementById('jobsContainer');

            const div = document.createElement('div');
            div.className = 'pagination-controls';

            // Prev
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerText = 'å‰ã¸';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                    document.getElementById('jobsContainer').scrollIntoView({ behavior: 'smooth' });
                }
            };

            // Info
            const info = document.createElement('span');
            info.className = 'page-info';
            info.innerText = `${currentPage} / ${totalPages}`;

            // Next
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerText = 'æ¬¡ã¸';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPage();
                    document.getElementById('jobsContainer').scrollIntoView({ behavior: 'smooth' });
                }
            };

            div.appendChild(prevBtn);
            div.appendChild(info);
            div.appendChild(nextBtn);

            container.appendChild(div);
        }

        function setupInteractions() {
            document.getElementById('searchBtn').addEventListener('click', filterAndRender);
            document.getElementById('sortSelect').addEventListener('change', filterAndRender);
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
    </script>
</body>

</html>